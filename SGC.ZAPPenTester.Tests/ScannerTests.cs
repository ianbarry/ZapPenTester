using FakeItEasy;

using Microsoft.VisualStudio.TestTools.UnitTesting;

using ZAPPenTester.Interfaces;

namespace ZAPPenTester.Tests
{
    [TestClass]
    public class ScannerTests
    {
        [TestMethod]
        public void Scan_NullResponse_ReturnsFalse()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);

            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, A<HttpResponseType>.Ignored)).Returns(null);

            bool hasStarted = scanner.Scan(new[] { "http://localhost/" });

            Assert.AreEqual(false, hasStarted);
        }

        [TestMethod]
        public void Scan_NotStarted_ReturnsFalse()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);
            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, A<HttpResponseType>.Ignored)).Returns("{\"status\":\"0\"}");

            bool hasStarted = scanner.Scan(new []{ "http://localhost/" });

            Assert.AreEqual(false, hasStarted);
        }

        [TestMethod]
        public void Scan_Started_ReturnsTrue()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);
            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, HttpResponseType.json)).Returns("{\"Result\":\"OK\"}");

            bool hasStarted = scanner.Scan(new[] { "http://localhost/" });

            Assert.AreEqual(true, hasStarted);
        }

        [TestMethod]
        public void Scan_Finished_ReturnsTrue()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);
            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, HttpResponseType.json)).Returns("{\"code\":\"scan_in_progress\"}");

            bool hasStarted = scanner.Scan(new[] { "http://localhost/" });

            Assert.AreEqual(true, hasStarted);
        }

        [TestMethod]
        public void HasCompleted_NullResponse_ReturnsFalse()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);

            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, A<HttpResponseType>.Ignored)).Returns(null);

            bool hasCompleted = scanner.HasCompleted();

            Assert.AreEqual(false, hasCompleted);
        }

        [TestMethod]
        public void HasCompleted_ResponseNot100_ReturnsFalse()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);
            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, A<HttpResponseType>.Ignored)).Returns("{\"status\":\"0\"}");

            bool hasCompleted = scanner.HasCompleted();

            Assert.AreEqual(false, hasCompleted);
        }

        [TestMethod]
        public void HasCompleted_Response100_ReturnsTrue()
        {
            var httpClientHelper = A.Fake<IHttpClientHelper>();
            var scanner = new Scanner(A.Fake<ISettings>(), A.Fake<ILogger>(), httpClientHelper);
            A.CallTo(() => httpClientHelper.MakeHttpRequest(A<string>.Ignored, A<HttpResponseType>.Ignored)).Returns("{\"status\":\"100\"}");

            bool hasCompleted = scanner.HasCompleted();

            Assert.AreEqual(true, hasCompleted);
        }
    }
}